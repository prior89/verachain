<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeraChain 사용자 기능 테스트</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; }
        .result { margin-top: 10px; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        input, button { margin: 5px; padding: 8px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>VeraChain 사용자 기능 테스트</h1>
    
    <div class="test-section">
        <h3>1. 연결 테스트</h3>
        <button onclick="testConnection()">백엔드 연결 확인</button>
        <div id="connectionResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>2. 회원가입</h3>
        <input type="email" id="registerEmail" placeholder="이메일" value="testuser@example.com">
        <input type="password" id="registerPassword" placeholder="비밀번호" value="Test123!@#">
        <input type="text" id="registerName" placeholder="이름" value="테스트사용자">
        <input type="text" id="registerWalletAddress" placeholder="지갑 주소" value="0x1234567890123456789012345678901234567890">
        <button onclick="testRegister()">회원가입 테스트</button>
        <div id="registerResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>3. 로그인</h3>
        <input type="email" id="loginEmail" placeholder="이메일" value="testuser@example.com">
        <input type="password" id="loginPassword" placeholder="비밀번호" value="Test123!@#">
        <button onclick="testLogin()">로그인 테스트</button>
        <div id="loginResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>4. 프로필 조회 (로그인 필요)</h3>
        <button onclick="testProfile()">내 프로필 조회</button>
        <div id="profileResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>5. 거래 내역 조회 (로그인 필요)</h3>
        <button onclick="testTransactions()">거래 내역 조회</button>
        <div id="transactionsResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>6. 제품 목록 조회</h3>
        <button onclick="testProducts()">제품 목록 조회</button>
        <div id="productsResult" class="result"></div>
    </div>

    <script>
        const API_BASE = 'https://verachain-backend2.onrender.com/api';
        let authToken = localStorage.getItem('token');

        function showResult(elementId, message, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${isSuccess ? 'success' : 'error'}`;
        }

        async function makeRequest(url, options = {}) {
            const config = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    ...options.headers
                },
                ...options
            };

            if (authToken && !config.headers.Authorization) {
                config.headers.Authorization = `Bearer ${authToken}`;
            }

            try {
                const response = await fetch(url, config);
                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function testConnection() {
            showResult('connectionResult', '연결 중...', true);
            
            const result = await makeRequest(`${API_BASE}/health`);
            
            if (result.success) {
                showResult('connectionResult', `연결 성공! 상태: ${result.data.status || 'OK'}`, true);
            } else {
                showResult('connectionResult', `연결 실패: ${result.error || result.data?.message || '알 수 없는 오류'}`, false);
            }
        }

        async function testRegister() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const name = document.getElementById('registerName').value;
            const walletAddress = document.getElementById('registerWalletAddress').value;

            showResult('registerResult', '회원가입 중...', true);

            const result = await makeRequest(`${API_BASE}/auth/register`, {
                method: 'POST',
                body: JSON.stringify({
                    email,
                    password,
                    name,
                    walletAddress
                })
            });

            if (result.success) {
                showResult('registerResult', `회원가입 성공!`, true);
            } else {
                showResult('registerResult', `회원가입 실패: ${result.data?.message || result.error}`, false);
            }
        }

        async function testLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            showResult('loginResult', '로그인 중...', true);

            const result = await makeRequest(`${API_BASE}/auth/login`, {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });

            if (result.success && result.data.token) {
                authToken = result.data.token;
                localStorage.setItem('token', authToken);
                showResult('loginResult', `로그인 성공! 사용자: ${result.data.user?.name || result.data.user?.email}`, true);
            } else {
                showResult('loginResult', `로그인 실패: ${result.data?.message || result.error}`, false);
            }
        }

        async function testProfile() {
            if (!authToken) {
                showResult('profileResult', '로그인이 필요합니다.', false);
                return;
            }

            showResult('profileResult', '프로필 조회 중...', true);

            const result = await makeRequest(`${API_BASE}/auth/profile`);

            if (result.success) {
                const user = result.data.user || result.data;
                showResult('profileResult', `프로필: ${user.name} (${user.email})`, true);
            } else {
                showResult('profileResult', `프로필 조회 실패: ${result.data?.message || result.error}`, false);
            }
        }

        async function testTransactions() {
            if (!authToken) {
                showResult('transactionsResult', '로그인이 필요합니다.', false);
                return;
            }

            showResult('transactionsResult', '거래 내역 조회 중...', true);

            const result = await makeRequest(`${API_BASE}/transactions`);

            if (result.success) {
                const transactions = result.data.transactions || result.data;
                showResult('transactionsResult', `거래 내역 ${Array.isArray(transactions) ? transactions.length : 0}개 조회됨`, true);
            } else {
                showResult('transactionsResult', `거래 내역 조회 실패: ${result.data?.message || result.error}`, false);
            }
        }

        async function testProducts() {
            showResult('productsResult', '제품 목록 조회 중...', true);

            const result = await makeRequest(`${API_BASE}/products`);

            if (result.success) {
                const products = result.data.products || result.data;
                showResult('productsResult', `제품 목록 ${Array.isArray(products) ? products.length : 0}개 조회됨`, true);
            } else {
                showResult('productsResult', `제품 목록 조회 실패: ${result.data?.message || result.error}`, false);
            }
        }

        // 페이지 로드 시 자동으로 연결 테스트
        window.onload = () => {
            testConnection();
        };
    </script>
</body>
</html>